---
# Source: iam/templates/iam-cert-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: iam
data:
  {}
---
# Source: iam/templates/iam-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: iam
data:
  iam-: ""
  iam-apiserver.yaml: |
  
    # iam-apiserver å…¨é…ç½?  
    # RESTful æœåŠ¡é…ç½®
    server:
        mode: debug # server mode: release, debug, testï¼Œé»˜è®?release
        healthz: true # æ˜¯å¦å¼€å¯å¥åº·æ£€æŸ¥ï¼Œå¦‚æœå¼€å¯ä¼šå®‰è£… /healthz è·¯ç”±ï¼Œé»˜è®?true
        middlewares: recovery,logger,secure,nocache,cors,dump # åŠ è½½çš?gin ä¸­é—´ä»¶åˆ—è¡¨ï¼Œå¤šä¸ªä¸­é—´ä»¶ï¼Œé€—å·(,)éš”å¼€
        max-ping-count: 3 # http æœåŠ¡å¯åŠ¨åï¼Œè‡ªæ£€å°è¯•æ¬¡æ•°ï¼Œé»˜è®?3
  
    # GRPC æœåŠ¡é…ç½®
    grpc:
      bind-address: 0.0.0.0 # grpc å®‰å…¨æ¨¡å¼çš?IP åœ°å€ï¼Œé»˜è®?0.0.0.0
      bind-port: 8081 # grpc å®‰å…¨æ¨¡å¼çš„ç«¯å£å·ï¼Œé»˜è®?8081
  
    # HTTP é…ç½®
    insecure:
        bind-address: 0.0.0.0 # ç»‘å®šçš„ä¸å®‰å…¨ IP åœ°å€ï¼Œè®¾ç½®ä¸º 0.0.0.0 è¡¨ç¤ºä½¿ç”¨å…¨éƒ¨ç½‘ç»œæ¥å£ï¼Œé»˜è®¤ä¸º 127.0.0.1
        bind-port: 8080 # æä¾›éå®‰å…¨è®¤è¯çš„ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 8080
  
    # HTTPS é…ç½®
    secure:
        bind-address: 0.0.0.0 # HTTPS å®‰å…¨æ¨¡å¼çš?IP åœ°å€ï¼Œé»˜è®¤ä¸º 0.0.0.0
        bind-port: 8443 # ä½¿ç”¨ HTTPS å®‰å…¨æ¨¡å¼çš„ç«¯å£å·ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºä¸å¯ç”?HTTPSï¼Œé»˜è®¤ä¸º 8443
        tls:
            #cert-dir: .iam/cert # TLS è¯ä¹¦æ‰€åœ¨çš„ç›®å½•ï¼Œé»˜è®¤å€¼ä¸º /var/run/iam
            #pair-name: iam # TLS ç§é’¥å¯¹åç§°ï¼Œé»˜è®¤ iam
            cert-key:
                cert-file: /etc/iam/cert/iam-apiserver.pem # åŒ…å« x509 è¯ä¹¦çš„æ–‡ä»¶è·¯å¾„ï¼Œç”?HTTPS è®¤è¯
                private-key-file: /etc/iam/cert/iam-apiserver-key.pem # TLS ç§é’¥
  
    # MySQL æ•°æ®åº“ç›¸å…³é…ç½?    mysql:
      host: 127.0.0.1:3306 # MySQL æœºå™¨ ip å’Œç«¯å£ï¼Œé»˜è®¤ 127.0.0.1:3306
      username: iam # MySQL ç”¨æˆ·å?å»ºè®®æˆæƒæœ€å°æƒé™é›†)
      password: iam59!z$ # MySQL ç”¨æˆ·å¯†ç 
      database: iam # iam ç³»ç»Ÿæ‰€ç”¨çš„æ•°æ®åº“å
      max-idle-connections: 100 # MySQL æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼Œé»˜è®?100
      max-open-connections: 100 # MySQL æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°ï¼Œé»˜è®?100
      max-connection-life-time: 10s # ç©ºé—²è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤ 10s
      log-level: 4 # GORM log level, 1: silent, 2:error, 3:warn, 4:info
  
    # Redis é…ç½®
    redis:
      host: 127.0.0.1 # redis åœ°å€ï¼Œé»˜è®?127.0.0.1:6379
      port: 6379 # redis ç«¯å£ï¼Œé»˜è®?6379
      password: iam59!z$ # redis å¯†ç 
      #addrs:
      #master-name: # redis é›†ç¾¤ master åç§°
      #username: # redis ç™»å½•ç”¨æˆ·å?      #database: # redis æ•°æ®åº?      #optimisation-max-idle:  # redis è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°
      #optimisation-max-active: # æœ€å¤§æ´»è·ƒè¿æ¥æ•°
      #timeout: # è¿æ¥ redis æ—¶çš„è¶…æ—¶æ—¶é—´
      #enable-cluster: # æ˜¯å¦å¼€å¯é›†ç¾¤æ¨¡å¼?      #use-ssl: # æ˜¯å¦å¯ç”¨ TLS
      #ssl-insecure-skip-verify: # å½“è¿æ?redis æ—¶å…è®¸ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
  
    # JWT é…ç½®
    jwt:
      realm: JWT # jwt æ ‡è¯†
      key: dfVpOK8LZeJLZHYmHdb1VdyRrACKpqoo # æœåŠ¡ç«¯å¯†é’?      timeout: 24h # token è¿‡æœŸæ—¶é—´(å°æ—¶)
      max-refresh: 24h # token æ›´æ–°æ—¶é—´(å°æ—¶)
  
    log:
        name: apiserver # Loggerçš„åå­?        development: true # æ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€?        level: debug # æ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šdebug, info, warn, error, dpanic, panic, fatalã€?        format: console # æ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒconsoleå’Œjsonä¸¤ç§ã€‚consoleå…¶å®å°±æ˜¯textæ ¼å¼ã€?        enable-color: true # æ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrue:æ˜¯ï¼Œfalse:å?        disable-caller: false # æ˜¯å¦å¼€å?callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·
        disable-stacktrace: false # æ˜¯å¦å†panicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ?        output-paths: /var/log/iam/iam-apiserver.log,stdout # æ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€ã€‚æ”¯æŒè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ–‡ä»¶ã€?        error-output-paths: /var/log/iam/iam-apiserver.error.log # zapå†…éƒ¨(éä¸šåŠ?é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€
  
    feature:
      enable-metrics: true # å¼€å?metrics, router:  /metrics
      profiling: true # å¼€å¯æ€§èƒ½åˆ†æ, å¯ä»¥é€šè¿‡ <host>:<port>/debug/pprof/åœ°å€æŸ¥çœ‹ç¨‹åºæ ˆã€çº¿ç¨‹ç­‰ç³»ç»Ÿä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true
  iam-authz-server.yaml: |
  
    # iam-authz-server å…¨é…ç½?  
    # IAM rpc æœåŠ¡åœ°å€
    rpcserver: 127.0.0.1:8081 # iam-apiserver grpc æœåŠ¡å™¨åœ°å€å’Œç«¯å?  
    # TLSå®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»?    client-ca-file: /etc/iam/cert/ca.pem # TLS å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¦‚æœæŒ‡å®šï¼Œåˆ™è¯¥å®¢æˆ·ç«¯è¯ä¹¦å°†è¢«ç”¨äºè®¤è¯
  
    # RESTful æœåŠ¡é…ç½®
    server:
        mode: debug # server mode: release, debug, testï¼Œé»˜è®¤release
        healthz: true # æ˜¯å¦å¼€å¯å¥åº·æ£€æŸ¥ï¼Œå¦‚æœå¼€å¯ä¼šå®‰è£… /healthz è·¯ç”±ï¼Œé»˜è®?true
        middlewares: recovery,logger,secure,nocache,cors,dump # åŠ è½½çš?gin ä¸­é—´ä»¶åˆ—è¡¨ï¼Œå¤šä¸ªä¸­é—´ä»¶ï¼Œé€—å·(,)éš”å¼€
  
    # HTTP é…ç½®
    insecure:
        bind-address: 0.0.0.0 # ç»‘å®šçš„ä¸å®‰å…¨ IP åœ°å€ï¼Œè®¾ç½®ä¸º 0.0.0.0 è¡¨ç¤ºä½¿ç”¨å…¨éƒ¨ç½‘ç»œæ¥å£ï¼Œé»˜è®¤ä¸º 127.0.0.1
        bind-port: 9090 # æä¾›éå®‰å…¨è®¤è¯çš„ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 8080
  
    # HTTPS é…ç½®
    secure:
        bind-address: 0.0.0.0 # HTTPS å®‰å…¨æ¨¡å¼çš?IP åœ°å€ï¼Œé»˜è®¤ä¸º 0.0.0.0
        bind-port: 9443 # ä½¿ç”¨ HTTPS å®‰å…¨æ¨¡å¼çš„ç«¯å£å·ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºä¸å¯ç”?HTTPSï¼Œé»˜è®¤ä¸º 8443
        tls:
            #cert-dir: .iam/cert # TLS è¯ä¹¦æ‰€åœ¨çš„ç›®å½•ï¼Œé»˜è®¤å€¼ä¸º /var/run/iam
            #pair-name: iam # TLS ç§é’¥å¯¹åç§°ï¼Œé»˜è®¤ iam
            cert-key:
                cert-file: /etc/iam/cert/iam-authz-server.pem # åŒ…å« x509 è¯ä¹¦çš„æ–‡ä»¶è·¯å¾„ï¼Œç”?HTTPS è®¤è¯
                private-key-file: /etc/iam/cert/iam-authz-server-key.pem # TLS ç§é’¥
  
    # Redis é…ç½®
    redis:
      host: 127.0.0.1 # redis åœ°å€ï¼Œé»˜è®?127.0.0.1:6379
      port: 6379 # redis ç«¯å£ï¼Œé»˜è®?6379
      password: iam59!z$ # redis å¯†ç 
      database: 0 # redis æ•°æ®åº?      #addrs:
      #master-name: # redis é›†ç¾¤ master åç§°
      #username: # redis ç™»å½•ç”¨æˆ·å?      #optimisation-max-idle:  # redis è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°
      #optimisation-max-active: # æœ€å¤§æ´»è·ƒè¿æ¥æ•°
      #timeout: # è¿æ¥ redis æ—¶çš„è¶…æ—¶æ—¶é—´
      #enable-cluster: # æ˜¯å¦å¼€å¯é›†ç¾¤æ¨¡å¼?      #use-ssl: # æ˜¯å¦å¯ç”¨ TLS
      #ssl-insecure-skip-verify: # å½“è¿æ?redis æ—¶å…è®¸ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
  
    log:
        name: authzserver # Loggerçš„åå­?        development: true # æ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€?        level: debug # æ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šdebug, info, warn, error, dpanic, panic, fatalã€?        format: console # æ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒconsoleå’Œjsonä¸¤ç§ã€‚consoleå…¶å®å°±æ˜¯textæ ¼å¼ã€?        enable-color: true # æ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrue:æ˜¯ï¼Œfalse:å?        disable-caller: false # æ˜¯å¦å¼€å?callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·
        disable-stacktrace: false # æ˜¯å¦å†panicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ?        output-paths: /var/log/iam/iam-authz-server.log,stdout # å¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€ã€‚stdoutï¼šæ ‡å‡†è¾“å‡ºï¼Œ
        error-output-paths: /var/log/iam/iam-authz-server.error.log # zapå†…éƒ¨(éä¸šåŠ?é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€
  
    analytics:
        enable: true # è®¾ç½®ä¸?true å?iam-authz-server ä¼šè®°å½•æˆæƒå®¡è®¡æ—¥å¿?        pool-size: 50 # æŒ‡å®š worker çš„ä¸ªæ•°ï¼Œé»˜è®¤ 50
        records-buffer-size:  2000 # ç¼“å­˜çš„æˆæƒæ—¥å¿—æ¶ˆæ¯æ•°
        flush-interval: 200 # è¶…æ—¶æŠ•é€’æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ï¼Œ0 < flush-interval <= 1000ã€?        enable-detailed-recording: true # å¼€å¯è®°å½•è¯¦æƒ…ï¼Œè¯¦ç»†è®°å½•çš„åŠŸèƒ?        storage-expiration-time: 24h0m0s # key è¿‡æœŸæ—¶é—´
  
    feature:
      enable-metrics: true # å¼€å?metrics, router:  /metrics
      profiling: true # å¼€å¯æ€§èƒ½åˆ†æ, å¯ä»¥é€šè¿‡ <host>:<port>/debug/pprof/åœ°å€æŸ¥çœ‹ç¨‹åºæ ˆã€çº¿ç¨‹ç­‰ç³»ç»Ÿä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true
  iam-pump.yaml: |
  
    purge-delay: 10 # å®¡è®¡æ—¥å¿—æ¸…ç†æ—¶é—´é—´éš”ï¼Œé»˜è®?10s
    health-check-path: healthz # å¥åº·æ£€æŸ¥è·¯ç”±ï¼Œé»˜è®¤ä¸?/healthz
    health-check-address: 0.0.0.0:7070 # å¥åº·æ£€æŸ¥ç»‘å®šç«¯å£ï¼Œé»˜è®¤ä¸?0.0.0.0:7070
    omit-detailed-recording: true # è®¾ç½®ä¸?true ä¼šè®°å½•è¯¦ç»†çš„æˆæƒå®¡è®¡æ—¥å¿—ï¼Œé»˜è®¤ä¸º false
  
    # Redis é…ç½®
    redis:
      host: 127.0.0.1 # redis åœ°å€ï¼Œé»˜è®?127.0.0.1:6379
      port: 6379 # redis ç«¯å£ï¼Œé»˜è®?6379
      password: iam59!z$ # redis å¯†ç 
      database: 0 # redis æ•°æ®åº?      optimisation-max-idle: 100  # redis è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°
      optimisation-max-active: 0 # æœ€å¤§æ´»è·ƒè¿æ¥æ•°
      enable-cluster: false # æ˜¯å¦å¼€å¯é›†ç¾¤æ¨¡å¼?      #addrs:
      #master-name: # redis é›†ç¾¤ master åç§°
      #username: # redis ç™»å½•ç”¨æˆ·å?      #timeout: # è¿æ¥ redis æ—¶çš„è¶…æ—¶æ—¶é—´
      #use-ssl: # æ˜¯å¦å¯ç”¨ TLS
      #ssl-insecure-skip-verify: # å½“è¿æ?redis æ—¶å…è®¸ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
  
    # pump é…ç½®
    pumps:
      mongo:
        type: mongo # pump ç±»å‹
        meta:
          collection_name: iam_analytics # mongodb collection name
          mongo_url: mongodb://iam:iam59!z$@127.0.0.1:27017/iam_analytics?authSource=iam_analytics # mongodb url
          collection_cap_max_size_bytes: 1048576 # è®¾ç½®æœ€å¤§çš„capped collection
          collection_cap_enable: true
  
    log:
        name: apiserver # Loggerçš„åå­?        development: true # æ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€?        level: debug # æ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šdebug, info, warn, error, dpanic, panic, fatalã€?        format: console # æ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒconsoleå’Œjsonä¸¤ç§ã€‚consoleå…¶å®å°±æ˜¯textæ ¼å¼ã€?        enable-color: true # æ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrue:æ˜¯ï¼Œfalse:å?        disable-caller: false # æ˜¯å¦å¼€å?callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·
        disable-stacktrace: false # æ˜¯å¦å†panicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ?        output-paths: /var/log/iam/iam-pump.log,stdout # å¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€ã€‚stdoutï¼šæ ‡å‡†è¾“å‡ºï¼Œ
        error-output-paths: /var/log/iam/iam-pump.error.log # zapå†…éƒ¨(éä¸šåŠ?é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€
  iamctl.yaml: |
    apiVersion: v1
    user:
      #token: # JWT Token
      username: admin # iam ç”¨æˆ·å?      password: Admin@2021 # iam å¯†ç 
      #secret-id: # å¯†é’¥ ID
      #secret-key: # å¯†é’¥ Key
      client-certificate: /home/colin/.iam/cert/admin.pem # ç”¨äº TLS çš„å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶è·¯å¾„
      client-key: /home/colin/.iam/cert/admin-key.pem # ç”¨äº TLS çš„å®¢æˆ·ç«¯ key æ–‡ä»¶è·¯å¾„
      #client-certificate-data:
      #client-key-data:
  
    server:
      address: 127.0.0.1:8443 # iam api-server åœ°å€
      timeout: 10s # è¯·æ±‚ api-server è¶…æ—¶æ—¶é—´
      #max-retries: # æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸?0
      #retry-interval: # é‡è¯•é—´éš”ï¼Œé»˜è®¤ä¸º 1s
      #tls-server-name: # TLS æœåŠ¡å™¨åç§?      #insecure-skip-tls-verify: # è®¾ç½®ä¸?true è¡¨ç¤ºè·³è¿‡ TLS å®‰å…¨éªŒè¯æ¨¡å¼ï¼Œå°†ä½¿å¾— HTTPS è¿æ¥ä¸å®‰å…?      certificate-authority: /etc/iam/cert/ca.pem # ç”¨äº CA æˆæƒçš?cert æ–‡ä»¶è·¯å¾„
      #certificate-authority-data:
---
# Source: iam/templates/iam-apiserver-service.yaml

apiVersion: v1
kind: Service
metadata:
  labels:
    app: iam-apiserver
  name: iam-apiserver
spec:
  ports:
  - name: https
    protocol: TCP
    port: 8443
    targetPort: 8443
  - name: http
    protocol: TCP
    port: 8080
    targetPort: 8080
  - name: rpc
    protocol: TCP
    port: 8081
    targetPort: 8081
  selector:
    app: iam-apiserver
  sessionAffinity: None
  type: ClusterIP
---
# Source: iam/templates/iam-authz-server-service.yaml

apiVersion: v1
kind: Service
metadata:
  labels:
    app: iam-authz-server
  name: iam-authz-server
spec:
  ports:
  - name: https
    protocol: TCP
    port: 9443
    targetPort: 9443
  - name: http
    protocol: TCP
    port: 9090
    targetPort: 9090
  selector:
    app: iam-authz-server
  sessionAffinity: None
  type: ClusterIP
---
# Source: iam/templates/iam-pump-service.yaml

apiVersion: v1
kind: Service
metadata:
  labels:
    app: iam-pump
  name: iam-pump
spec:
  ports:
  - name: http
    protocol: TCP
    port: 7070
    targetPort: 7070
  selector:
    app: iam-pump
  sessionAffinity: None
  type: ClusterIP
---
# Source: iam/templates/iam-apiserver-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: iam-apiserver
  name: iam-apiserver
spec:
  replicas: 1
  progressDeadlineSeconds: 10
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: iam-apiserver
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: iam-apiserver
    spec:
      imagePullSecrets:
        - name: ccr-registry
      securityContext:
        {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - iam-apiserver
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /opt/iam/bin/iam-apiserver
        - --config=/etc/iam/iam-apiserver.yaml
        image: "ccr.ccs.tencentyun.com/marmotedu/iam-apiserver-amd64:v1.6.2"
        name: iam-apiserver
        ports:
        - containerPort: 8443
          name: secure
          protocol: TCP
        - containerPort: 8080
          name: insecure
          protocol: TCP
        - containerPort: 8081
          name: rpc 
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        startupProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          failureThreshold: 10
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 250m
              memory: 512Mi
        imagePullPolicy: Always
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/iam/iam-apiserver.yaml
          name: iam
          subPath: iam-apiserver.yaml
        - mountPath: /etc/iam/cert
          name: iam-cert
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
            {}
      terminationGracePeriodSeconds: 5
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: iam-apiserver.yaml
            path: iam-apiserver.yaml
          name: iam
        name: iam
      - configMap:
          defaultMode: 420
          name: iam-cert
        name: iam-cert
---
# Source: iam/templates/iam-authz-server-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: iam-authz-server
  name: iam-authz-server
spec:
  replicas: 1
  progressDeadlineSeconds: 10
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: iam-authz-server
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: iam-authz-server
    spec:
      imagePullSecrets:
        - name: ccr-registry
      securityContext:
        {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - iam-authz-server
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /opt/iam/bin/iam-authz-server
        - --config=/etc/iam/iam-authz-server.yaml
        image: "ccr.ccs.tencentyun.com/marmotedu/iam-authz-server-amd64:v1.6.2"
        name: iam-authz-server
        ports:
        - containerPort: 9443
          name: secure
          protocol: TCP
        - containerPort: 9090
          name: insecure
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9090
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 9090
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        startupProbe:
          httpGet:
            path: /healthz
            port: 9090
            scheme: HTTP
          failureThreshold: 10
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 250m
              memory: 512Mi
        imagePullPolicy: Always
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/iam/iam-authz-server.yaml
          name: iam
          subPath: iam-authz-server.yaml
        - mountPath: /etc/iam/cert
          name: iam-cert
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
            {}
      terminationGracePeriodSeconds: 5
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: iam-authz-server.yaml
            path: iam-authz-server.yaml
          name: iam
        name: iam
      - configMap:
          defaultMode: 420
          name: iam-cert
        name: iam-cert
---
# Source: iam/templates/iam-pump-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: iam-pump
  name: iam-pump
spec:
  replicas: 1
  progressDeadlineSeconds: 10
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: iam-pump
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: iam-pump
    spec:
      imagePullSecrets:
        - name: ccr-registry
      securityContext:
        {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - iam-pump
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /opt/iam/bin/iam-pump
        - --config=/etc/iam/iam-pump.yaml
        image: "ccr.ccs.tencentyun.com/marmotedu/iam-pump-amd64:v1.6.2"
        name: iam-pump
        ports:
        - containerPort: 9443
          name: secure
          protocol: TCP
        - containerPort: 9090
          name: insecure
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 7070
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 7070
            scheme: HTTP
          failureThreshold: 1
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        startupProbe:
          httpGet:
            path: /healthz
            port: 7070
            scheme: HTTP
          failureThreshold: 10
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 250m
              memory: 512Mi
        imagePullPolicy: Always
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/iam/iam-pump.yaml
          name: iam
          subPath: iam-pump.yaml
        - mountPath: /etc/iam/cert
          name: iam-cert
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
            {}
      terminationGracePeriodSeconds: 5
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: iam-pump.yaml
            path: iam-pump.yaml
          name: iam
        name: iam
      - configMap:
          defaultMode: 420
          name: iam-cert
        name: iam-cert
---
# Source: iam/templates/iamctl-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: iamctl
  name: iamctl
spec:
  replicas: 1
  progressDeadlineSeconds: 10
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: iamctl
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: iamctl
    spec:
      imagePullSecrets:
        - name: ccr-registry
      securityContext:
        {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - iamctl
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - sleep
        - "3600"
        image: "ccr.ccs.tencentyun.com/marmotedu/iamctl-amd64:v1.6.2"
        name: iamctl
        resources:
          limits: 
            cpu: 250m
            memory: 500Mi
          requests:
            cpu: 250m 
            memory: 200Mi
        imagePullPolicy: Always
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        env:
          - name: IAM_AUTHZ_SERVER_HOST
            value: iam-authz-server
          - name: IAM_APISERVER_HOST
            value: iam-apiserver
          - name: IAM_PUMP_HOST
            value: iam-pump
        volumeMounts:
        - mountPath: /etc/iam/iamctl.yaml
          name: iam
          subPath: iamctl.yaml
        - mountPath: /etc/iam/cert
          name: iam-cert
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
            {}
      terminationGracePeriodSeconds: 5
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: iamctl.yaml
            path: iamctl.yaml
          name: iam
        name: iam
      - configMap:
          defaultMode: 420
          name: iam-cert
        name: iam-cert
---
# Source: iam/templates/hpa.yaml
