
apiVersion: apps/v1
kind: Deployment
metadata:
  labels: # è®¾å®šèµ„æºçš„æ ‡ç­?    app: iam-apiserver
  name: iam-apiserver
  namespace: default
spec:
  progressDeadlineSeconds: 10 # æŒ‡å®šå¤šå°‘æ—¶é—´å†…ä¸èƒ½å®Œæˆæ»šåŠ¨å‡çº§å°±è§†ä¸ºå¤±è´¥ï¼Œæ»šåŠ¨å‡çº§è‡ªåŠ¨å–æ¶?  replicas: 1 # å£°æ˜å‰¯æœ¬æ•°ï¼Œå»ºè®® >= 2
  revisionHistoryLimit: 5 # è®¾ç½®ä¿ç•™çš„å†å²ç‰ˆæœ¬ä¸ªæ•°ï¼Œé»˜è®¤æ˜?0
  selector: # é€‰æ‹©å™?    matchLabels: # åŒ¹é…æ ‡ç­¾
      app: iam-apiserver # æ ‡ç­¾æ ¼å¼ä¸ºkey: valueå¯?  strategy: # æŒ‡å®šéƒ¨ç½²ç­–ç•¥
    rollingUpdate:
      maxSurge: 1 # æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•?      maxUnavailable: 1 # è¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­èƒ½å¤Ÿè¿›å…¥ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•?    type: RollingUpdate # æ›´æ–°ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šé‡å»º(Recreate)ã€RollingUpdate(æ»šåŠ¨æ›´æ–°)
  template: # æŒ‡å®šPodåˆ›å»ºæ¨¡æ¿ã€‚æ³¨æ„ï¼šä»¥ä¸‹å®šä¹‰ä¸ºPodçš„èµ„æºå®šä¹?    metadata: # æŒ‡å®šPodçš„å…ƒæ•°æ®
      labels: # æŒ‡å®šPodçš„æ ‡ç­?        app: iam-apiserver 
    spec:
      affinity:
        podAntiAffinity: # Podåäº²å’Œæ€§ï¼Œå°½é‡é¿å…åŒä¸€ä¸ªåº”ç”¨è°ƒåº¦åˆ°ç›¸åŒNode
          preferredDuringSchedulingIgnoredDuringExecution: # è½¯éœ€æ±?          - podAffinityTerm:
              labelSelector:
                matchExpressions: # æœ‰å¤šä¸ªé€‰é¡¹ï¼Œåªæœ‰åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶çš„èŠ‚ç‚¹æ‰èƒ½è¿è¡Œ Pod
                - key: app
                  operator: In # è®¾å®šæ ‡ç­¾é”®ä¸ä¸€ç»„å€¼çš„å…³ç³»ï¼ŒInã€NotInã€Existsã€DoesNotExist
                  values:
                  - iam-apiserver
              topologyKey: kubernetes.io/hostname
            weight: 100 # weight å­—æ®µå€¼çš„èŒƒå›´æ˜?-100ã€?      containers: 
      - command: # æŒ‡å®šè¿è¡Œå‘½ä»¤
        - /opt/iam/bin/iam-apiserver # è¿è¡Œå‚æ•°
        - --config=/etc/iam/iam-apiserver.yaml
        image: ccr.ccs.tencentyun.com/lkccc/iam-apiserver-amd64:v1.0.6 # é•œåƒåï¼Œéµå®ˆé•œåƒå‘½åè§„èŒƒ
        imagePullPolicy: Always # é•œåƒæ‹‰å–ç­–ç•¥ã€‚IfNotPresentï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼›Neverï¼šä½¿ç”¨æœ¬åœ°é•œåƒï¼Œæœ¬åœ°é•œåƒä¸å­˜åœ¨ï¼Œåˆ™æŠ¥é”™ï¼›Alwaysï¼šé»˜è®¤å€¼ï¼Œæ¯æ¬¡éƒ½é‡æ–°æ‹‰å–é•œåƒ?        # lifecycle: # kubernetesæ”¯æŒpostStartå’ŒpreStopäº‹ä»¶ã€‚å½“ä¸€ä¸ªå®¹å™¨å¯åŠ¨åï¼ŒKuberneteså°†ç«‹å³å‘é€postStartäº‹ä»¶ï¼›åœ¨å®¹å™¨è¢«ç»ˆç»“ä¹‹å‰ï¼ŒKuberneteså°†å‘é€ä¸€ä¸ªpreStopäº‹ä»¶
        name: iam-apiserver # å®¹å™¨åç§°ï¼Œä¸åº”ç”¨åç§°ä¿æŒä¸€è‡?        ports: # ç«¯å£è®¾ç½®
        - containerPort: 8443 # å®¹å™¨æš´éœ²çš„ç«¯å?          name: secure # ç«¯å£åç§°
          protocol: TCP # åè®®ï¼ŒTCPå’ŒUDP
        livenessProbe: # å­˜æ´»æ£€æŸ¥ï¼Œæ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸ï¼Œä¸æ­£å¸¸åˆ™é‡å¯å®ä¾‹
          httpGet: # HTTPè¯·æ±‚æ£€æŸ¥æ–¹æ³?            path: /healthz # è¯·æ±‚è·¯å¾„
            port: 8080 # æ£€æŸ¥ç«¯å?            scheme: HTTP # æ£€æŸ¥åè®?          initialDelaySeconds: 5 # å¯åŠ¨å»¶æ—¶ï¼Œå®¹å™¨å»¶æ—¶å¯åŠ¨å¥åº·æ£€æŸ¥çš„æ—¶é—´
          periodSeconds: 10 # é—´éš”æ—¶é—´ï¼Œè¿›è¡Œå¥åº·æ£€æŸ¥çš„æ—¶é—´é—´éš”
          successThreshold: 1 # å¥åº·é˜€å€¼ï¼Œè¡¨ç¤ºåç«¯å®¹å™¨ä»å¤±è´¥åˆ°æˆåŠŸçš„è¿ç»­å¥åº·æ£€æŸ¥æˆåŠŸæ¬¡æ•?          failureThreshold: 1 # ä¸å¥åº·é˜€å€¼ï¼Œè¡¨ç¤ºåç«¯å®¹å™¨ä»æˆåŠŸåˆ°å¤±è´¥çš„è¿ç»­å¥åº·æ£€æŸ¥æˆåŠŸæ¬¡æ•?          timeoutSeconds: 3 # å“åº”è¶…æ—¶ï¼Œæ¯æ¬¡å¥åº·æ£€æŸ¥å“åº”çš„æœ€å¤§è¶…æ—¶æ—¶é—?        readinessProbe: # å°±ç»ªæ£€æŸ¥ï¼Œæ£€æŸ¥å®¹å™¨æ˜¯å¦å°±ç»ªï¼Œä¸å°±ç»ªåˆ™åœæ­¢è½¬å‘æµé‡åˆ°å½“å‰å®ä¾?          httpGet: # HTTPè¯·æ±‚æ£€æŸ¥æ–¹æ³?            path: /healthz # è¯·æ±‚è·¯å¾„
            port: 8080 # æ£€æŸ¥ç«¯å?            scheme: HTTP # æ£€æŸ¥åè®?          initialDelaySeconds: 5 # å¯åŠ¨å»¶æ—¶ï¼Œå®¹å™¨å»¶æ—¶å¯åŠ¨å¥åº·æ£€æŸ¥çš„æ—¶é—´
          periodSeconds: 10 # é—´éš”æ—¶é—´ï¼Œè¿›è¡Œå¥åº·æ£€æŸ¥çš„æ—¶é—´é—´éš”
          successThreshold: 1 # å¥åº·é˜€å€¼ï¼Œè¡¨ç¤ºåç«¯å®¹å™¨ä»å¤±è´¥åˆ°æˆåŠŸçš„è¿ç»­å¥åº·æ£€æŸ¥æˆåŠŸæ¬¡æ•?          failureThreshold: 1 # ä¸å¥åº·é˜€å€¼ï¼Œè¡¨ç¤ºåç«¯å®¹å™¨ä»æˆåŠŸåˆ°å¤±è´¥çš„è¿ç»­å¥åº·æ£€æŸ¥æˆåŠŸæ¬¡æ•?          timeoutSeconds: 3 # å“åº”è¶…æ—¶ï¼Œæ¯æ¬¡å¥åº·æ£€æŸ¥å“åº”çš„æœ€å¤§è¶…æ—¶æ—¶é—?        startupProbe: # å¯åŠ¨æ¢é’ˆï¼Œå¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºå®¹å™¨ä»€ä¹ˆæ—¶å€™å¯åŠ¨äº†
          failureThreshold: 10
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources: # èµ„æºç®¡ç†
          limits: # limitsç”¨äºè®¾ç½®å®¹å™¨ä½¿ç”¨èµ„æºçš„æœ€å¤§ä¸Šé™?é¿å…å¼‚å¸¸æƒ…å†µä¸‹èŠ‚ç‚¹èµ„æºæ¶ˆè€—è¿‡å¤?            cpu: "1" # è®¾ç½®cpu limitï¼?æ ¸å¿ƒ = 1000m
            memory: 1Gi # è®¾ç½®memory limitï¼?G = 1024Mi
          requests: # requestsç”¨äºé¢„åˆ†é…èµ„æº?å½“é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ²¡æœ‰requestæ‰€è¦æ±‚çš„èµ„æºæ•°é‡æ—¶,å®¹å™¨ä¼šåˆ›å»ºå¤±è´?            cpu: 250m # è®¾ç½®cpu request
            memory: 500Mi # è®¾ç½®memory request
        terminationMessagePath: /dev/termination-log # å®¹å™¨ç»ˆæ­¢æ—¶æ¶ˆæ¯ä¿å­˜è·¯å¾?        terminationMessagePolicy: File # ä»…ä»ç»ˆæ­¢æ¶ˆæ¯æ–‡ä»¶ä¸­æ£€ç´¢ç»ˆæ­¢æ¶ˆæ?        volumeMounts: # æŒ‚è½½æ—¥å¿—å?        - mountPath: /etc/iam/iam-apiserver.yaml # å®¹å™¨å†…æŒ‚è½½é•œåƒè·¯å¾?          name: iam # å¼•ç”¨çš„å·åç§°
          subPath: iam-apiserver.yaml # æŒ‡å®šæ‰€å¼•ç”¨çš„å·å†…çš„å­è·¯å¾„ï¼Œè€Œä¸æ˜¯å…¶æ ¹è·¯å¾„ã€?        - mountPath: /etc/iam/cert
          name: iam-cert
      dnsPolicy: ClusterFirst
      restartPolicy: Always # é‡å¯ç­–ç•¥ï¼ŒAlwaysã€OnFailureã€Never
      schedulerName: default-scheduler # æŒ‡å®šè°ƒåº¦å™¨çš„åå­—
      imagePullSecrets: # åœ¨Podä¸­è®¾ç½®ImagePullSecretsåªæœ‰æä¾›è‡ªå·±å¯†é’¥çš„Podæ‰èƒ½è®¿é—®ç§æœ‰ä»“åº“
        - name: ccr-registry # é•œåƒä»“åº“çš„Secretséœ€è¦åœ¨é›†ç¾¤ä¸­æ‰‹åŠ¨åˆ›å»?      securityContext: {} # æŒ‡å®šå®‰å…¨ä¸Šä¸‹æ–?      terminationGracePeriodSeconds: 5 # ä¼˜é›…å…³é—­æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å†…ä¼˜é›…å…³é—­æœªç»“æŸï¼Œk8s å¼ºåˆ¶ kill
      volumes: # é…ç½®æ•°æ®å·ï¼Œç±»å‹è¯¦è§https://kubernetes.io/zh/docs/concepts/storage/volumes
      - configMap: # configMap ç±»å‹çš„æ•°æ®å·
          defaultMode: 420 #æƒé™è®¾ç½®0~0777ï¼Œé»˜è®?664
          items:
          - key: iam-apiserver.yaml
            path: iam-apiserver.yaml
          name: iam # configmapåç§°
        name: iam # è®¾ç½®å·åç§°ï¼Œä¸volumeMountsåç§°å¯¹åº”
      - configMap:
          defaultMode: 420
          name: iam-cert
        name: iam-cert
